apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    version: "{{TRAVIS_COMMIT}}"
    razee.io/git-repo: "{{{GIT_REMOTE}}}"
    razee.io/commit-sha: "{{TRAVIS_COMMIT}}"
  name: watch-keeper
  labels:
    razee/watch-resource: "lite"
spec:
  replicas: 1
  revisionHistoryLimit: 0
  selector:
    matchLabels:
      app: watch-keeper
  strategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: watch-keeper
        razee/watch-resource: "lite"
      name: watch-keeper
    spec:
      serviceAccountName: watch-keeper-sa
      containers:
      - env:
          - name: START_DELAY_MAX
            valueFrom:
              configMapKeyRef:
                name: watch-keeper-config
                key: START_DELAY_MAX
                optional: true
          - name: NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: CONFIG_NAMESPACE
            valueFrom:
              configMapKeyRef:
                name: watch-keeper-config
                key: CONFIG_NAMESPACE
                optional: true
          - name: CLUSTER_ID_OVERRIDE
            valueFrom:
              configMapKeyRef:
                name: watch-keeper-config
                key: CLUSTER_ID_OVERRIDE
                optional: true
          - name: DEFAULT_CLUSTER_NAME
            valueFrom:
              configMapKeyRef:
                name: watch-keeper-config
                key: DEFAULT_CLUSTER_NAME
                optional: true
          - name: KUBECONFIG
            valueFrom:
              configMapKeyRef:
                name: watch-keeper-config
                key: KUBECONFIG
                optional: true
          - name: RAZEEDASH_URL
            valueFrom:
              configMapKeyRef:
                name: watch-keeper-config
                key: RAZEEDASH_URL
          - name: RAZEEDASH_ORG_KEY
            valueFrom:
              secretKeyRef:
                name: watch-keeper-secret
                key: RAZEEDASH_ORG_KEY
          - name: NODE_ENV
            value: "production"
        image: "quay.io/razee/watch-keeper:{{TRAVIS_TAG}}"
        imagePullPolicy: Always
        name: watch-keeper
        resources:
          limits:
            memory: 500Mi
            cpu: 400m
          requests:
            memory: 100Mi
            cpu: 50m
        livenessProbe:
          exec:
            command:
            - sh/liveness.sh
          initialDelaySeconds: 600
          periodSeconds: 300
          timeoutSeconds: 30
          failureThreshold: 1
